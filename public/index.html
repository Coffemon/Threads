<!DOCTYPE html>
<html>
<head>
	<title> Threadz</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
	<link rel="stylesheet" href="style.css">

</head>

<body>
<!-- <header id="main-header" role="banner"><img src="/img/logo.png" alt="Chat logo"></header> -->

<ul id="ul"> 

<!-- Här hamnar allt det icke-statiska, det som ska ändras och hämtas.
Istället för att ladda om hela sidan varje gång, laddar vi bara om denna listan.
Knappar och inputs är samma hela tiden -->

</ul>


<!-- TEMPLATE--> 

		<script type="text/x-handlebars-template" id="template">
				<div id="chatwindow">
					<div id="messagewindow">
						{{#each threads}}
							<p class='name'>{{title}}:</p>
								<div class='bubble'>
									<p class='speech'>{{text}}</p>
								</div>	
						{{/each}}
					</div>
				</div>
		</script>
<!-- TEMPLATE SLUT -->
<div id="inputcontainer">
	<input name="title" id="titleinput" placeholder="Name">
	<input name="text" id="textinput" placeholder="Your message">
	<button class="button send-button"> Send </button>
	<button class="button delete-button"> Delete </button>
	<button class="button change-button"> Put </button>
</div>
			


<script>
// Hämtar ny data på 200 ms

setInterval(function getThreads() {    
		$.ajax({
	  		url: "api/threads"
		}).done(function (data){
			// DATA = Data från servern, alltså vår threads-array!!

			var src = document.getElementById("template").innerHTML;
			var render = Handlebars.compile(src); 
			var html = render(data);
			document.getElementById("ul").innerHTML = html;
		});
}, 200)	
//////////////////////////////////////////////////


//funktion för att skicka ny tråd

function postThread() {
	var title = document.getElementById("titleinput").value; 
  	var text = document.getElementById("textinput").value;
  	var textValue = textinput.value;
  	var textValueLength = textinput.value.length;
  	var titleValue = titleinput.value;
  	var titleValueLength = titleinput.value.length;

  	// If sats som förhindrar att man kan skicka tomma meddelanden
  	// Förhindrar även från att skicka meddelanden utan namn.
 	if(textValue !== '' && textValueLength > 0) {
		if(titleValue !== '' && titleValueLength > 0) {


			$.ajax({
			  	url: "api/threads",
			  	method: "POST",
			  	data: {title: title, text: text} // data till servern!
			}).done(function (data){
		  		textinput.value = '';
			})
		}	
	}
}

// Post med hjälp av enter!!
$(document).ready(function(){
    $('#textinput').keypress(function(e){
      	if(e.keyCode==13)
      	$('.send-button').click();
   	});
});

// funktion för att ändra tråd.
function putThread() {
  	var title = document.getElementById("titleinput").value; 
  	var text = document.getElementById("textinput").value; 
	var id = prompt("vilken tråd vill du ändra?")

	$.ajax({
	  	url: "api/threads/" +id,
	  	method: "PUT",
	  	data: {title: title, text: text} // nya data till server!
	}).done(function (data){
			
	})
}
////////////////////////////////////////////////////////


/// funktion för att ta bort en hel tråd
function deleteThread() {
	var id = prompt("vilket id vill du radera?");

	$.ajax({
	  	url: "api/threads/" +id,
	  	type: "DELETE",
	}).done(function (data){	

	})
}

var sendBtn = document.querySelector('.send-button');
sendBtn.addEventListener('click', postThread);

var deleteBtn = document.querySelector('.delete-button');
deleteBtn.addEventListener('click', deleteThread);

var changeBtn = document.querySelector('.change-button');
changeBtn.addEventListener('click', putThread);



</script>
</body>
</html>